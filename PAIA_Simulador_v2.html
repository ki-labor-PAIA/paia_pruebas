<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PAIA Builder UI - Professional</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Professional PAIA Builder Interface">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* Botones Redise√±ados */
    .button-group {
      margin: 12px 0;
      padding: 12px 0;
      border-top: 1px solid var(--border-color);
    }

    .button-group:first-child {
      border-top: none;
      padding-top: 0;
    }

    .button-group-title {
      font-size: 0.8em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .button-group-title::before {
      content: "";
      display: block;
      width: 12px;
      height: 1px;
      background: var(--border-color);
    }

    .button-group-title::after {
      content: "";
      display: block;
      flex: 1;
      height: 1px;
      background: var(--border-color);
    }

    /* Estilo para botones discretos */
    .discreet-button {
      background: transparent !important;
      border: 1px solid var(--border-color) !important;
      color: var(--text-secondary) !important;
      padding: 8px 12px !important;
      margin-bottom: 8px;
      transition: all 0.2s ease;
      width: 100%;
    }

    .discreet-button:hover {
      background: rgba(255,255,255,0.05) !important;
      color: var(--text-primary) !important;
      border-color: var(--primary-color) !important;
    }

    .discreet-button i {
      margin-right: 6px;
      font-size: 0.9em;
    }

    /* Botones de acci√≥n principal */
    .primary-action-button {
      margin-top: 8px;
    }

    /* Botones de simulaci√≥n */
    .simulation-button {
      background: var(--success-color) !important;
      color: white !important;
    }

    .simulation-button:hover {
      background: #0ea371 !important;
    }

    .reset-button {
      background: var(--danger-color) !important;
      color: white !important;
    }

    .reset-button:hover {
      background: #dc2626 !important;
    }

    /* Mejorar el input file */
    #importJson + label {
      display: block;
      width: 100%;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      font-size: 0.9em;
      background: rgba(255,255,255,0.05);
      color: var(--text-secondary);
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }

    #importJson + label:hover {
      background: rgba(255,255,255,0.1);
      color: var(--text-primary);
    }

    #importJson + label i {
      margin-right: 6px;
    }
    :root {
      --primary-color: #4a6bdf;
      --primary-dark: #3a56b8;
      --secondary-color: #6c5ce7;
      --dark-bg: #0f172a;
      --darker-bg: #0a1120;
      --sidebar-bg: #1e293b;
      --card-bg: #1e293b;
      --border-color: #2d3748;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
    }
    
    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--dark-bg);
      color: var(--text-primary);
      display: flex;
      height: 100vh;
      overflow: hidden;
      line-height: 1.5;
    }
    
    .sidebar {
      width: 200px;
      background: var(--sidebar-bg);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      overflow-y: auto;
      height: 100vh;
      position: fixed;
      top: 0;
    }

    #left-sidebar {
      left: 0;
      border-right: 1px solid var(--border-color);
    }

    #right-sidebar {
      right: 0;
      border-left: 1px solid var(--border-color);
    }
    
    #sidebar h2 {
      color: var(--text-primary);
      font-size: 1.4em;
      font-weight: 600;
      margin: 0 0 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    #sidebar h2::before {
      content: "‚öôÔ∏è";
      font-size: 1.2em;
    }
    
    #sidebar input, 
    #sidebar textarea, 
    #sidebar select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      font-size: 0.9em;
      background: rgba(255,255,255,0.05);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }
    
    #sidebar input:focus, 
    #sidebar textarea:focus, 
    #sidebar select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(74, 107, 223, 0.2);
    }
    
    #sidebar textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    #sidebar button {
      width: 100%;
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      font-size: 0.9em;
      font-weight: 500;
      background-color: var(--primary-color);
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    #sidebar button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    #sidebar button:active {
      transform: translateY(0);
    }
    
    #canvas {
      flex: 1;
      position: relative;
      background: var(--darker-bg);
      background-image: 
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 20px 20px;
      margin: 0 250px; /* Asegura que el contenido no est√© detr√°s de las barras laterales */
      min-height: 100vh;
    }
    .node {
      position: absolute;
      padding: 15px;
      border-radius: 12px;
      color: white;
      font-weight: 500;
      font-size: 16px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      cursor: move;
      z-index: 1;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 80px;
      height: 80px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .node:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    
    .node::after {
      content: attr(data-name);
      position: absolute;
      bottom: -28px;
      font-size: 12px;
      font-weight: 400;
      color: var(--text-primary);
      white-space: nowrap;
      text-align: center;
      width: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      padding: 2px 6px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .node:hover::after {
      opacity: 1;
    }
    
    .node.ai {
      background: var(--primary-color);
      border-color: #5d7eff;
    }
    
    .node.human {
      background: var(--warning-color);
      border-color: #fbbf24;
    }
    
    .node.highlight {
      transform: scale(1.05);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
      z-index: 10;
    }
    .message-bubble {
      position: absolute;
      background: rgba(255,255,255,0.9);
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 13px;
      max-width: 200px;
      color: #333;
      z-index: 2;
      animation: fadein 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-weight: 500;
    }
    
    @keyframes fadein {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes floatUp {
      0% { 
        opacity: 0; 
        transform: translateY(10px) scale(0.9);
      }
      20% { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      80% {
        opacity: 1;
      }
      100% { 
        opacity: 0;
        transform: translateY(-30px) scale(1.1);
      }
    }
    .connector {
      stroke: rgba(255,255,255,0.3);
      stroke-width: 2px;
      fill: none;
      marker-end: url(#arrow);
      transition: all 0.3s ease;
    }
    
    .connector:hover {
      stroke: rgba(255,255,255,0.6);
      stroke-width: 3px;
    }
    
    .connector.active {
      stroke: var(--primary-color);
      stroke-width: 3px;
      stroke-dasharray: 4;
      animation: dashmove 1s linear infinite;
    }
    
    @keyframes dashmove {
      to { stroke-dashoffset: -16; }
    }
    svg {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 0;
    }
    #log {
      position: absolute;
      bottom: 20px;
      left: 300px;
      right: 300px;
      background: rgba(0,0,0,0.7);
      padding: 12px 16px;
      font-size: 0.85em;
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
      backdrop-filter: blur(5px);
      border: 1px solid var(--border-color);
    }
    
    #log b {
      font-weight: 600;
      color: var(--primary-color);
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: var(--dark-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 100%;
    }
    .modal-header {
      margin-bottom: 16px;
    }
    .modal-body {
      margin-bottom: 16px;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
    }
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
  </style>
</head>
<body>
  <!-- Modal de instrucciones -->
  <div id="guideModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Gu√≠a R√°pida</h3>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 16px; display: flex; align-items: flex-start; gap: 12px;">
          <div style="background: var(--primary-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">1</div>
          <div>
            <h4 style="margin: 0 0 4px 0; font-size: 1em; color: var(--text-primary);">A√±ade actores</h4>
            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9em;">Crea actores humanos o de IA para tu escenario.</p>
          </div>
        </div>
        <div style="margin-bottom: 16px; display: flex; align-items: flex-start; gap: 12px;">
          <div style="background: var(--primary-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">2</div>
          <div>
            <h4 style="margin: 0 0 4px 0; font-size: 1em; color: var(--text-primary);">Con√©ctalos</h4>
            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9em;">Define las interacciones entre los actores.</p>
          </div>
        </div>
        <div style="display: flex; align-items: flex-start; gap: 12px;">
          <div style="background: var(--primary-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">3</div>
          <div>
            <h4 style="margin: 0 0 4px 0; font-size: 1em; color: var(--text-primary);">Simula el escenario</h4>
            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9em;">Observa la din√°mica de las interacciones.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeGuide()" class="btn btn-primary">Comenzar</button>
      </div>
    </div>
  </div>

  <!-- Left Sidebar -->
  <div id="left-sidebar" class="sidebar">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2>PAIA Builder</h2>
      <button onclick="openGuide()" class="discreet-button" style="width: auto; padding: 6px 8px !important;" title="Mostrar gu√≠a">
        <i class="fas fa-question"></i>
      </button>
    </div>

    <select id="presetScenarios" class="discreet-button" style="margin-bottom: 0;">
      <option value="">Elegir escenario...</option>
      <option value="trash">üóëÔ∏è Basura</option>
      <option value="calendar">üìÖ Calendario</option>
      <option value="party">üéâ Cancelar fiesta</option>
    </select>

    <input type="text" id="scenarioName" placeholder="Nombre del escenario">
    <textarea id="scenarioDesc" placeholder="Descripci√≥n del escenario..." rows="3"></textarea>

    <!-- Grupo para importar/exportar -->
    <div class="button-group">
      <div class="button-group-title">Gesti√≥n de Escenarios</div>
      <input type="file" id="importJson" accept="application/json" style="display: none;">
      <button onclick="document.getElementById('importJson').click()" class="discreet-button">
        <i class="fas fa-file-import"></i> Importar JSON
      </button>
      <button onclick="exportScenario()" class="discreet-button">
        <i class="fas fa-file-export"></i> Exportar JSON
      </button>
    </div>

    <!-- Grupo para simulaci√≥n -->
    <div class="button-group">
      <div class="button-group-title">Simulaci√≥n</div>
      <button onclick="simulateScenario()" class="discreet-button simulation-button">
        <i class="fas fa-play"></i> Simular
      </button>
      <button onclick="resetSimulation()" class="discreet-button reset-button">
        <i class="fas fa-redo"></i> Reiniciar
      </button>
    </div>
  </div>

  <!-- Right Sidebar -->
  <div id="right-sidebar" class="sidebar">
    <!-- Grupo para agregar actores -->
    <div class="button-group">
      <div class="button-group-title">Agregar Actores</div>
      <button onclick="addActor('human')" class="discreet-button">
        <i class="fas fa-user"></i> Humano
      </button>
      <button onclick="addActor('ai')" class="discreet-button">
        <i class="fas fa-robot"></i> Asistente IA
      </button>
    </div>

    <!-- Grupo para conexiones -->
    <div class="button-group">
      <div class="button-group-title">Conexiones</div>
      <button onclick="connectActors()" class="discreet-button">
        <i class="fas fa-link"></i> Conectar
      </button>
    </div>
  </div>
  
  <!-- Panel de estad√≠sticas de interacci√≥n -->
  <div id="interactionStats" style="position: fixed; top: 30px; right: 270px; width: 240px; background-color: var(--dark-bg); padding: 12px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 500; border: 1px solid var(--border-color);">
    <h4 style="margin: 0 0 8px 0; font-size: 0.9em; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 6px;">üìä Estad√≠sticas</h4>
    <ul id="statsList" style="list-style: none; padding: 0; margin: 0; font-size: 0.85em;">
      <li style="margin-bottom: 6px; display: flex; justify-content: space-between;">
        <span style="color: var(--text-secondary);">Tiempo:</span>
        <span id="responseTime" style="color: var(--text-primary); font-weight: 500;">0s</span>
      </li>
      <li style="margin-bottom: 6px; display: flex; justify-content: space-between;">
        <span style="color: var(--text-secondary);">Consultas:</span>
        <span id="queriesProcessed" style="color: var(--text-primary); font-weight: 500;">0</span>
      </li>
      <li style="display: flex; justify-content: space-between;">
        <span style="color: var(--text-secondary);">Estado:</span>
        <span id="interactionStatus" style="color: var(--success-color); font-weight: 500; font-size: 0.9em;">En espera...</span>
      </li>
    </ul>
  </div>

  <!-- Panel de decisiones de IA -->
  <div id="aiDecisions" style="position: fixed; bottom: 20px; right: 20px; width: 240px; height: 180px; background-color: var(--dark-bg); padding: 12px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 500; border: 1px solid var(--border-color); display: flex; flex-direction: column;">
    <h4 style="margin: 0 0 8px 0; font-size: 0.9em; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 6px;">ü§ñ Decisiones</h4>
    <div id="decisionList" style="flex-grow: 1; overflow-y: auto; padding-right: 5px; font-size: 0.85em;">
      <div class="ai-message" style="background: rgba(59, 130, 246, 0.1); padding: 6px 10px; border-radius: 6px; margin-bottom: 6px; border-right: 3px solid var(--primary-color);">
        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 2px;">Sistema</div>
        <div style="color: var(--text-primary);">Listo para simular</div>
      </div>
    </div>
  </div>

  <div id="canvas"></div>
  <svg id="lines">
    <defs>
      <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="5" orient="auto" markerUnits="strokeWidth">
        <path d="M0,0 L10,5 L0,10 Z" fill="#ccc" />
      </marker>
    </defs>
  </svg>
  <div id="log"></div>
  <div id="simulationProgress" style="position: fixed; bottom: 0; left: 300px; right: 150px; height: 4px; background: rgba(0,0,0,0.2); display: none; z-index: 100;">
    <div id="progressBar" style="width: 0%; height: 100%; background: var(--success-color); transition: width 0.3s ease;"></div>
  </div>

  <script>
    // Funciones para la gu√≠a
    function openGuide() {
      document.getElementById('guideModal').style.display = 'block';
    }

    function closeGuide() {
      document.getElementById('guideModal').style.display = 'none';
    }

    // Mostrar gu√≠a al cargar la p√°gina
    setTimeout(openGuide, 1000);

    document.getElementById('presetScenarios').addEventListener('change', (e) => {
      const selected = e.target.value;
      if (!selected) return;
      const scenarios = {
        trash: {
          name: "Basura",
          description: "La esposa le pide a la IA del esposo que le recuerde sacar la basura al terminar su junta.",
          actors: [
            { id: "h1", name: "Esposa", type: "human", position: { x: 100, y: 100 } },
            { id: "h2", name: "Juan", type: "human", position: { x: 400, y: 100 } },
            { id: "ai1", name: "PAIA de Juan", type: "ai", position: { x: 250, y: 200 } }
          ],
          interactions: [
            { source: "h1", target: "ai1" },
            { source: "ai1", target: "h2" }
          ]
        },
        calendar: {
          name: "Calendario",
          description: "El asistente agenda una reuni√≥n y manda un recordatorio al usuario.",
          actors: [
            { id: "h1", name: "Usuario", type: "human", position: { x: 100, y: 120 } },
            { id: "ai1", name: "PAIA del Usuario", type: "ai", position: { x: 300, y: 120 } }
          ],
          interactions: [
            { source: "ai1", target: "h1" }
          ]
        },
        party: {
          name: "Cancelar fiesta",
          description: "Una persona con COVID-19 usa su PAIA para cancelar una fiesta programada.",
          actors: [
            { id: "h1", name: "Anfitri√≥n", type: "human", position: { x: 100, y: 120 } },
            { id: "ai1", name: "PAIA del Anfitri√≥n", type: "ai", position: { x: 300, y: 120 } },
            { id: "h2", name: "Invitado", type: "human", position: { x: 500, y: 120 } }
          ],
          interactions: [
            { source: "h1", target: "ai1" },
            { source: "ai1", target: "h2" }
          ]
        }
      };

      const s = scenarios[selected];
      document.getElementById('scenarioName').value = s.name;
      document.getElementById('scenarioDesc').value = s.description;
      canvas.innerHTML = '';
      connections = [];
      nodes.length = 0;

      s.actors.forEach(a => addActor(a.type, a.name, a.id, a.position.x, a.position.y));
      s.interactions.forEach(i => {
        const from = nodes.find(n => n.dataset.id === i.source);
        const to = nodes.find(n => n.dataset.id === i.target);
        if (from && to) connectActors(from, to);
      });
    });
  </script>
  <script>
  let canvas = document.getElementById('canvas');
  let actorId = 1;
  let connections = [];
  const nodes = [];

  function addActor(type, name = null, id = null, x = null, y = null) {
    const node = document.createElement('div');
    node.className = `node ${type}`;
    node.innerHTML = type === 'human' ? 'üë§' : 'ü§ñ';
    node.style.backgroundColor = type === 'human' ? '#f39c12' : '#3498db';
    node.style.borderColor = type === 'human' ? '#f7b95a' : '#5ab0f7';
    node.setAttribute('data-name', name || `${type === 'human' ? 'Humano' : 'IA'} ${actorId}`);
    
    // Enable editing on double-click
    setupNodeEditing(node);
    node.textContent = name || `${type === 'human' ? 'Humano' : 'IA'} ${actorId}`;
    node.style.left = `${x ?? (100 + actorId * 60)}px`;
    node.style.top = `${y ?? (100 + actorId * 30)}px`;
    node.dataset.id = id || `actor-${actorId}`;
    node.dataset.type = type;
    actorId++;
    enableDrag(node);
    canvas.appendChild(node);
    nodes.push(node);
  }

  function enableDrag(node) {
    let offsetX, offsetY;
    node.onmousedown = function(e) {
      offsetX = e.offsetX;
      offsetY = e.offsetY;
      document.onmousemove = function(e) {
        node.style.left = `${e.pageX - offsetX}px`;
        node.style.top = `${e.pageY - offsetY}px`;
        drawConnections();
      };
      document.onmouseup = function() {
        document.onmousemove = null;
      };
    }
  }

  function connectActors(fromNode = null, toNode = null) {
    if (fromNode && toNode) {
      connections.push({ from: fromNode, to: toNode });
    } else if (nodes.length >= 2) {
      connections.push({ from: nodes[nodes.length - 2], to: nodes[nodes.length - 1] });
    }
    drawConnections();
  }

  function drawConnections() {
    const svg = document.getElementById('lines');
    svg.innerHTML = document.querySelector('svg defs').outerHTML;
    connections.forEach(({ from, to }) => {
      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      const rectFrom = from.getBoundingClientRect();
      const rectTo = to.getBoundingClientRect();
      line.setAttribute("x1", rectFrom.left + rectFrom.width / 2);
      line.setAttribute("y1", rectFrom.top + rectFrom.height / 2);
      line.setAttribute("x2", rectTo.left + rectTo.width / 2);
      line.setAttribute("y2", rectTo.top + rectTo.height / 2);
      line.setAttribute("class", "connector");
      svg.appendChild(line);
    });
  }

  function highlightNodes(from, to) {
    // Remove highlight from all nodes first
    document.querySelectorAll('.node').forEach(n => n.classList.remove('highlight'));
    
    // Add highlight to the active nodes
    from.classList.add('highlight');
    to.classList.add('highlight');
    
    // Auto-scroll to make sure the nodes are visible
    const fromRect = from.getBoundingClientRect();
    const toRect = to.getBoundingClientRect();
    
    const visibleArea = {
      top: window.scrollY,
      bottom: window.scrollY + window.innerHeight,
      left: window.scrollX,
      right: window.scrollX + window.innerWidth
    };
    
    // Check if nodes are out of view and scroll to them if needed
    if (fromRect.top < visibleArea.top || fromRect.bottom > visibleArea.bottom ||
        toRect.top < visibleArea.top || toRect.bottom > visibleArea.bottom) {
      const middleY = (fromRect.top + toRect.top) / 2 - window.innerHeight / 2;
      window.scrollTo({
        top: middleY,
        behavior: 'smooth'
      });
    }
    canvas.appendChild(msg);
    setTimeout(() => msg.remove(), 2000);
  }

  // Variables globales para el seguimiento de estad√≠sticas
  let interactionStartTime = 0;
  let queriesProcessed = 0;
  let activeConnections = new Set();

  // Funci√≥n para actualizar estad√≠sticas
  function updateStats(status) {
    const elapsedTime = interactionStartTime > 0 ? Math.floor((Date.now() - interactionStartTime) / 1000) : 0;
    document.getElementById('responseTime').textContent = `${elapsedTime}s`;
    document.getElementById('queriesProcessed').textContent = queriesProcessed;
    document.getElementById('interactionStatus').textContent = status;
    
    // Actualizar color del estado seg√∫n el estado actual
    const statusElement = document.getElementById('interactionStatus');
    if (status.includes('error') || status.includes('Error')) {
      statusElement.style.color = 'var(--danger-color)';
    } else if (status.includes('completada') || status.includes('√©xito')) {
      statusElement.style.color = 'var(--success-color)';
    } else if (status.includes('procesando')) {
      statusElement.style.color = 'var(--warning-color)';
    } else {
      statusElement.style.color = 'var(--text-primary)';
    }
  }

  // Funci√≥n para agregar un mensaje al panel de decisiones de IA
  function addAIDecision(sender, message, isSystem = false) {
    const decisionList = document.getElementById('decisionList');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'ai-message';
    messageDiv.style = `background: ${isSystem ? 'rgba(75, 85, 99, 0.1)' : 'rgba(59, 130, 246, 0.1)'}; padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; border-right: 3px solid ${isSystem ? 'var(--text-secondary)' : 'var(--primary-color)'};`;
    
    const senderDiv = document.createElement('div');
    senderDiv.style = 'font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;';
    senderDiv.textContent = isSystem ? 'Sistema' : `PAIA de ${sender}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.style = 'color: var(--text-primary);';
    contentDiv.textContent = message;
    
    messageDiv.appendChild(senderDiv);
    messageDiv.appendChild(contentDiv);
    
    decisionList.insertBefore(messageDiv, decisionList.firstChild);
    
    // Limitar a 10 mensajes
    if (decisionList.children.length > 10) {
      decisionList.removeChild(decisionList.lastChild);
    }
  }

  // Funci√≥n para crear una l√≠nea de conexi√≥n animada entre nodos
  function createAnimatedLine(from, to, color = '#3b82f6') {
    const fromRect = from.getBoundingClientRect();
    const toRect = to.getBoundingClientRect();
    const canvas = document.getElementById('canvas');
    const canvasRect = canvas.getBoundingClientRect();
    
    // Calcular posiciones relativas al canvas
    const fromX = fromRect.left + fromRect.width / 2 - canvasRect.left + window.scrollX;
    const fromY = fromRect.top + fromRect.height / 2 - canvasRect.top + window.scrollY;
    const toX = toRect.left + toRect.width / 2 - canvasRect.left + window.scrollX;
    const toY = toRect.top + toRect.height / 2 - canvasRect.top + window.scrollY;
    
    // Crear ID √∫nico para la conexi√≥n
    const connectionId = `conn-${from.id}-${to.id}-${Date.now()}`;
    
    // Crear el elemento de l√≠nea
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', fromX);
    line.setAttribute('y1', fromY);
    line.setAttribute('x2', fromX);
    line.setAttribute('y2', fromY);
    line.setAttribute('stroke', color);
    line.setAttribute('stroke-width', '2');
    line.setAttribute('stroke-dasharray', '5,3');
    line.setAttribute('class', 'connection-line');
    line.setAttribute('id', connectionId);
    line.setAttribute('marker-end', 'url(#arrow)');
    
    // Agregar al SVG
    const linesSvg = document.getElementById('lines');
    linesSvg.appendChild(line);
    
    // Animar la l√≠nea
    const duration = 800; // ms
    const startTime = performance.now();
    
    function animate(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      const x = fromX + (toX - fromX) * progress;
      const y = fromY + (toY - fromY) * progress;
      
      line.setAttribute('x2', x);
      line.setAttribute('y2', y);
      
      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        // Cuando termina la animaci√≥n, esperar un poco y luego desaparecer
        setTimeout(() => {
          line.style.opacity = '0';
          line.style.transition = 'opacity 0.5s';
          
          setTimeout(() => {
            if (line.parentNode) {
              line.parentNode.removeChild(line);
            }
            activeConnections.delete(connectionId);
          }, 500);
        }, 500);
      }
    }
    
    activeConnections.add(connectionId);
    requestAnimationFrame(animate);
    
    return connectionId;
  }

  function simulateScenario() {
    const log = document.getElementById('log');
    const progressContainer = document.getElementById('simulationProgress');
    const progressBar = document.getElementById('progressBar');
    
    // Inicializar estad√≠sticas
    interactionStartTime = Date.now();
    queriesProcessed = 0;
    updateStats('Iniciando simulaci√≥n...');
    
    // Limpiar paneles
    document.getElementById('decisionList').innerHTML = '';
    log.innerHTML = '<b>üß† Iniciando simulaci√≥n...</b><br>';
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    
    // Agregar mensaje inicial al panel de decisiones
    addAIDecision('Sistema', 'Iniciando simulaci√≥n de interacciones entre PAIA', true);
    
    let i = 0;
    const totalSteps = connections.length;
    
    // Reset all highlights
    document.querySelectorAll('.node').forEach(n => n.classList.remove('highlight'));
    
    async function step() {
      if (i >= totalSteps) {
        // Simulation complete
        const endMessage = '‚úÖ Simulaci√≥n completada con √©xito';
        log.innerHTML += `<br><b>${endMessage}</b>`;
        updateStats(endMessage);
        addAIDecision('Sistema', 'Simulaci√≥n completada exitosamente', true);
        
        setTimeout(() => {
          progressContainer.style.display = 'none';
        }, 1000);
        return;
      }
      
      const { from, to } = connections[i];
      const fromName = from.getAttribute('data-name') || from.textContent;
      const toName = to.getAttribute('data-name') || to.textContent;
      const fromType = from.getAttribute('data-type');
      const toType = to.getAttribute('data-type');
      
      // Actualizar estad√≠sticas
      queriesProcessed++;
      updateStats('Procesando interacci√≥n...');
      
      // Update progress
      const progress = ((i + 1) / totalSteps) * 100;
      progressBar.style.width = `${progress}%`;
      
      // Highlight the current connection
      highlightNodes(from, to);
      
      // Crear l√≠nea de conexi√≥n animada
      const connectionColor = fromType === 'ai' && toType === 'ai' ? '#8b5cf6' : '#3b82f6';
      createAnimatedLine(from, to, connectionColor);
      
      // Add message to log with timestamp
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      
      // Determinar el tipo de interacci√≥n
      let interactionType = '';
      if (fromType === 'ai' && toType === 'ai') {
        interactionType = 'ü§ñ PAIA a PAIA';
      } else if (fromType === 'ai') {
        interactionType = 'ü§ñ PAIA a Humano';
      } else if (toType === 'ai') {
        interactionType = 'üë§ Humano a PAIA';
      } else {
        interactionType = 'üë• Humano a Humano';
      }
      
      log.innerHTML += `[${timeString}] ${interactionType}: <b>${fromName}</b> ‚Üí <b>${toName}</b><br>`;
      
      // Si es una interacci√≥n entre PAIA, agregar detalles al panel de decisiones
      if (fromType === 'ai' || toType === 'ai') {
        const aiActor = fromType === 'ai' ? fromName : toName;
        const message = fromType === 'ai' 
          ? `Enviando consulta a ${toName}` 
          : `Procesando solicitud de ${fromName}`;
        
        addAIDecision(aiActor, message);
        
        // Simular procesamiento de IA
        if (fromType === 'ai') {
          setTimeout(() => {
            const responses = [
              `He procesado la solicitud de ${toName} y estoy generando una respuesta.`,
              `Analizando los datos recibidos de ${toName}...`,
              `Generando recomendaci√≥n basada en la interacci√≥n con ${toName}`,
              `Consulta procesada exitosamente para ${toName}`
            ];
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            addAIDecision(aiActor, randomResponse);
          }, 500);
        }
      }
      
      // Auto-scroll log to bottom
      log.scrollTop = log.scrollHeight;
      
      // Show a floating message between nodes
      const messageText = fromType === 'ai' && toType === 'ai' 
        ? `ü§ñ Intercambio de datos` 
        : `Mensaje ${i + 1}`;
      
      showMessage(from, to, messageText);
      
      i++;
      
      // Usar un tiempo de espera din√°mico basado en el tipo de interacci√≥n
      const delay = fromType === 'ai' && toType === 'ai' ? 1800 : 1400;
      setTimeout(step, delay);
    }
    
    // Start simulation with a small delay to allow UI to update
    setTimeout(step, 500);
  }

  function resetSimulation() {
    document.getElementById('log').innerHTML = '';
    document.querySelectorAll('.node').forEach(n => n.classList.remove('highlight'));
    updateStats('En espera...');
    addAIDecision('Sistema', 'Simulaci√≥n reiniciada. Listo para comenzar una nueva simulaci√≥n.', true);
    
    // Limpiar l√≠neas de conexi√≥n
    document.querySelectorAll('.connection-line').forEach(line => {
      line.parentNode.removeChild(line);
    });
    activeConnections.clear();
  }

  function exportScenario() {
    const scenario = {
      name: document.getElementById('scenarioName').value,
      description: document.getElementById('scenarioDesc').value,
      actors: nodes.map(node => ({
        id: node.dataset.id,
        name: node.textContent,
        type: node.dataset.type,
        position: {
          x: parseInt(node.style.left),
          y: parseInt(node.style.top)
        }
      })),
      interactions: connections.map(conn => ({
        source: conn.from.dataset.id,
        target: conn.to.dataset.id
      }))
    };
    const blob = new Blob([JSON.stringify(scenario, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${scenario.name || 'paia_scenario'}.json`;
    a.click();
  }

  function importScenario() {
    const input = document.getElementById('importJson');
    if (!input.files[0]) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const content = JSON.parse(e.target.result);
      canvas.innerHTML = '';
      connections = [];
      nodes.length = 0;
      document.getElementById('scenarioName').value = content.name || '';
      document.getElementById('scenarioDesc').value = content.description || '';
      content.actors.forEach(actor => {
        addActor(actor.type, actor.name, actor.id, actor.position.x, actor.position.y);
      });
      content.interactions.forEach(interaction => {
        const from = nodes.find(n => n.dataset.id === interaction.source);
        const to = nodes.find(n => n.dataset.id === interaction.target);
        if (from && to) connectActors(from, to);
      });
    };
    reader.readAsText(input.files[0]);
  }

  function showMessage(fromNode, toNode, text) {
    const msg = document.createElement('div');
    msg.className = 'message-bubble';
    
    // Calculate position between the two nodes
    const rectFrom = fromNode.getBoundingClientRect();
    const rectTo = toNode.getBoundingClientRect();
    
    const x = (rectFrom.left + rectTo.left) / 2;
    const y = (rectFrom.top + rectTo.top) / 2;
    
    // Position the message
    msg.style.left = `${x}px`;
    msg.style.top = `${y}px`;
    msg.textContent = text;
    
    // Add animation
    msg.style.animation = 'floatUp 1.5s ease-out forwards';
    
    document.body.appendChild(msg);
    
    // Remove the message after animation
    setTimeout(() => {
      msg.remove();
    }, 2000);
  }

function setupNodeEditing(node) {
  node.addEventListener('dblclick', (e) => {
    e.stopPropagation();
    openEditForm(node);
  });
}

function openEditForm(node) {
  // Create modal overlay
  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.top = '0';
  overlay.style.left = '0';
  overlay.style.right = '0';
  overlay.style.bottom = '0';
  overlay.style.backgroundColor = 'rgba(0,0,0,0.7)';
  overlay.style.display = 'flex';
  overlay.style.justifyContent = 'center';
  overlay.style.alignItems = 'center';
  overlay.style.zIndex = '1000';
  
  // Create form
  const form = document.createElement('div');
  form.style.background = '#2a2a3a';
  form.style.padding = '20px';
  form.style.borderRadius = '10px';
  form.style.width = '300px';
  form.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
  
  // Get current values
  const isAI = node.classList.contains('ai');
  const currentName = node.getAttribute('data-name') || node.textContent;
  const currentColor = node.style.backgroundColor || (isAI ? '#3498db' : '#f39c12');
  
  // Form content
  form.innerHTML = `
    <h3 style="margin-top: 0; color: #ddd;">Editar Actor</h3>
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; color: #aaa;">Nombre:</label>
      <input type="text" id="editActorName" value="${currentName}" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #333; color: #fff;">
    </div>
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 5px; color: #aaa;">Color:</label>
      <input type="color" id="editActorColor" value="${currentColor}" style="width: 100%; height: 40px; border: none; border-radius: 4px; cursor: pointer;">
    </div>
    <div style="display: flex; justify-content: flex-end; gap: 10px;">
      <button id="cancelEdit" style="padding: 8px 16px; background: #555; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancelar</button>
      <button id="saveEdit" style="padding: 8px 16px; background: #5562eb; color: white; border: none; border-radius: 4px; cursor: pointer;">Guardar</button>
    </div>
  `;
  
  // Add form to overlay
  overlay.appendChild(form);
  document.body.appendChild(overlay);
  
  // Focus on input
  const nameInput = form.querySelector('#editActorName');
  nameInput.focus();
  nameInput.select();
  
  // Event listeners
  form.querySelector('#saveEdit').addEventListener('click', () => {
    const newName = nameInput.value.trim();
    const newColor = form.querySelector('#editActorColor').value;
    
    if (newName) {
      node.setAttribute('data-name', newName);
      node.textContent = isAI ? 'ü§ñ' : 'üë§';
      node.style.backgroundColor = newColor;
      node.style.borderColor = lightenColor(newColor, 30);
    }
    
    document.body.removeChild(overlay);
  });
  
  form.querySelector('#cancelEdit').addEventListener('click', () => {
    document.body.removeChild(overlay);
  });
  
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      document.body.removeChild(overlay);
    }
  });
}

// Helper function to lighten colors
function lightenColor(color, percent) {
  const num = parseInt(color.replace('#', ''), 16);
  const amt = Math.round(2.55 * percent);
  const R = (num >> 16) + amt;
  const G = (num >> 8 & 0x00FF) + amt;
  const B = (num & 0x0000FF) + amt;
  return '#' + (
    0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
    (B < 255 ? B < 1 ? 0 : B : 255)
  ).toString(16).slice(1);
}

</script>

</body>
</html>
